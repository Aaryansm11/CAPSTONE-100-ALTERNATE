@startuml
title ECG/PPG Arrhythmia Discovery & Stroke Risk Prediction System – Complete Architecture

skinparam rectangle {
  BackgroundColor #f8f9fa
  BorderColor #333333
  RoundCorner 10
}
skinparam component {
  BackgroundColor #ffffff
  BorderColor #666666
  FontColor #000000
}
skinparam database {
  BackgroundColor #e3f2fd
  BorderColor #1976d2
}
skinparam ArrowColor #333333
skinparam ArrowThickness 2

' ========== DATA SOURCE LAYER ==========
rectangle "Data Source Layer" as SOURCE #ffe0b2 {
  database "MIMIC-III Database" as MIMIC {
    component "Waveform Records\n(WFDB format)" as WFDB
    component "Clinical Data\n(CSV files)" as CLINICAL
    component "CHARTEVENTS\n(Vital signs)" as CHART
    component "PATIENTS\n(Demographics)" as PATIENTS
    component "DIAGNOSES_ICD\n(ICD codes)" as DIAGNOSES
  }
}

' ========== DATA PROCESSING LAYER ==========
rectangle "Data Processing Pipeline" as PIPELINE #c8e6c9 {
  rectangle "production_pipeline.py" as PRODPIPE {
    component "Patient Matcher\n- Link waveform to clinical\n- CHA₂DS₂-VASc scoring" as MATCHER
    component "Signal Extractor\n- Load WFDB records\n- Extract 8 channels\n  (3 ECG + 5 PPG)" as EXTRACTOR
    component "Signal Processor\n- Bandpass filter (0.5-40Hz)\n- Z-score normalization\n- Quality validation" as PROCESSOR
    component "Segmenter\n- 10-second windows\n- Overlap: 10%\n- Min/Max segments filter" as SEGMENTER
  }

  component "Dataset Builder\n- HDF5 format\n- Metadata pickle\n- Chunked processing" as BUILDER
}

' ========== STORAGE LAYER ==========
rectangle "Storage Layer" as STORAGE #fff9c4 {
  database "Production Dataset" as DATASET {
    component "full_dataset.h5\n- Shape: (133,157 × 1,250 × 8)\n- Size: 5.33 GB\n- Format: HDF5" as H5FILE
    component "full_dataset_metadata.pkl\n- Patient IDs\n- CHA₂DS₂-VASc scores\n- Clinical features" as METADATA
    component "config.json\n- Hyperparameters\n- Paths\n- Training settings" as CONFIG
  }

  database "File Storage" as FILES {
    component "Model Checkpoints\n- best_model.pth\n- checkpoint_epoch_*.pth" as CHECKPOINTS
    component "Training Logs\n- Loss curves\n- Metrics history" as LOGS
    component "Embeddings\n- embeddings.npy\n- 256-dim vectors" as EMBEDDINGS
  }
}

' ========== TRAINING LAYER ==========
rectangle "Model Training Layer" as TRAINING #e1bee7 {
  rectangle "Discovery Model Training" as DISCOVERY {
    component "conservative_full_training.py" as TRAIN_SCRIPT

    rectangle "Data Augmentation" as AUG {
      component "StrongAugmentation\n- Time warping\n- Gaussian noise\n- Amplitude scaling\n- Time shifting" as AUGMENT
    }

    rectangle "Model Architecture" as ARCH {
      component "WaveformEncoder\n- Conv1D blocks (64→128→256→512)\n- Global pooling\n- Dense (256-dim)\n- Dropout: 0.2" as ENCODER
    }

    rectangle "Training Strategy" as STRATEGY {
      component "Contrastive Learning\n- SimCLR framework\n- NT-Xent loss\n- Temperature: 0.07" as CONTRASTIVE
      component "Optimizer\n- AdamW\n- LR: 0.002\n- Weight decay: 0.05" as OPTIMIZER
      component "Regularization\n- Early stopping (patience=5)\n- Dropout (0.2)\n- Validation split (20%)" as REGULARIZATION
    }
  }

  rectangle "Stroke Classifier Training" as CLASSIFIER {
    component "Embedding Extractor\n- Load trained encoder\n- Generate embeddings\n- Save to .npy" as EMB_EXTRACTOR
    component "Supervised Classifier\n- Input: 256-dim embeddings\n- Architecture: MLP\n- Output: Stroke risk" as SUPERVISED
    component "Training\n- Cross-entropy loss\n- Target: 90%+ accuracy\n- Stratified K-fold CV" as STROKE_TRAIN
  }
}

' ========== MODEL REPOSITORY ==========
rectangle "Model Repository" as REPO #b2dfdb {
  component "Discovery Model\n- WaveformEncoder\n- 986K parameters\n- Pattern recognition" as DISC_MODEL
  component "Stroke Predictor\n- MLP Classifier\n- Embedding → Risk\n- Target: 90%+ ACC" as STROKE_MODEL
}

' ========== INFERENCE LAYER ==========
rectangle "Inference & XAI Layer" as INFERENCE #bbdefb {
  rectangle "Inference Engine" as ENGINE {
    component "Model Loader\n- Load checkpoints\n- GPU/CPU selection\n- Batch inference" as LOADER
    component "Prediction Service\n- Real-time inference\n- Risk scoring\n- Confidence estimation" as PREDICTOR
  }

  rectangle "Explainable AI Module" as XAI {
    component "Gradient Analysis\n- Channel importance\n- Temporal saliency\n- Integrated gradients" as GRADIENTS
    component "Signal Analyzer\n- Peak detection\n- Heart rate estimation\n- HRV calculation\n- Abnormality detection" as SIGNAL_ANALYZER
    component "Clinical Interpreter\n- Tachycardia/Bradycardia\n- Irregular beats\n- Low amplitude warnings" as INTERPRETER
  }
}

' ========== APPLICATION LAYER ==========
rectangle "Application Layer" as APPLICATION #f3e5f5 {
  rectangle "Streamlit Dashboard" as STREAMLIT {
    component "enhanced_xai_app.py" as MAINAPP

    rectangle "Pages" as PAGES {
      component "Patient Analysis\n- Synthetic generation\n- Manual entry\n- Real-time analysis" as PATIENT_PAGE
      component "Pipeline Explanation\n- Architecture diagrams\n- Training visualizations\n- System overview" as PIPELINE_PAGE
    }

    component "Report Generator\n- PDF reports\n- XAI visualizations\n- Clinical findings\n- Risk assessment" as REPORT_GEN
  }

  component "Session Management\n- Patient state\n- Analysis cache\n- Results storage" as SESSION
}

' ========== CLIENT LAYER ==========
rectangle "Client Layer" as CLIENT #e8f5e9 {
  component "Web Browser\n- Chrome/Firefox/Edge\n- Port: 8502\n- Responsive UI" as BROWSER
  component "Medical Workstation\n- Hospital terminal\n- Secure access\n- Full features" as WORKSTATION
}

' ========== FLOWS ==========

' Data ingestion
WFDB --> MATCHER : "Waveform data"
CLINICAL --> MATCHER : "Patient demographics"
CHART --> MATCHER : "Vital signs"
PATIENTS --> MATCHER : "Patient info"
DIAGNOSES --> MATCHER : "ICD codes"

' Processing pipeline
MATCHER --> EXTRACTOR : "Matched records"
EXTRACTOR --> PROCESSOR : "Raw 8-channel signals"
PROCESSOR --> SEGMENTER : "Filtered signals"
SEGMENTER --> BUILDER : "10s segments"
BUILDER --> H5FILE : "Write HDF5"
BUILDER --> METADATA : "Write metadata"

' Training data flow
H5FILE --> TRAIN_SCRIPT : "Load segments"
METADATA --> TRAIN_SCRIPT : "Load clinical data"
CONFIG --> TRAIN_SCRIPT : "Hyperparameters"

TRAIN_SCRIPT --> AUGMENT : "Raw segments"
AUGMENT --> ENCODER : "Augmented views (2x)"
ENCODER --> CONTRASTIVE : "Embeddings"
CONTRASTIVE --> OPTIMIZER : "Loss gradients"
OPTIMIZER --> ENCODER : "Weight updates"
TRAIN_SCRIPT ..> REGULARIZATION : "Apply"

ENCODER --> CHECKPOINTS : "Save checkpoints"
TRAIN_SCRIPT --> LOGS : "Training metrics"

' Embedding extraction
CHECKPOINTS --> EMB_EXTRACTOR : "Load best model"
H5FILE --> EMB_EXTRACTOR : "Full dataset"
EMB_EXTRACTOR --> EMBEDDINGS : "256-dim embeddings"

' Classifier training
EMBEDDINGS --> SUPERVISED : "Training features"
METADATA --> SUPERVISED : "Stroke labels"
SUPERVISED --> STROKE_TRAIN : "Training loop"
STROKE_TRAIN --> CHECKPOINTS : "Save classifier"

' Model repository
CHECKPOINTS --> DISC_MODEL : "Discovery model"
CHECKPOINTS --> STROKE_MODEL : "Stroke classifier"

' Inference flow
DISC_MODEL --> LOADER : "Load models"
STROKE_MODEL --> LOADER : "Load models"
LOADER --> PREDICTOR : "Ready for inference"

' XAI flow
PREDICTOR --> GRADIENTS : "Embeddings + gradients"
PREDICTOR --> SIGNAL_ANALYZER : "Raw segments"
SIGNAL_ANALYZER --> INTERPRETER : "Signal features"
GRADIENTS --> INTERPRETER : "Attribution maps"

' Application flow
INTERPRETER --> MAINAPP : "XAI results"
PREDICTOR --> MAINAPP : "Predictions"
MAINAPP --> PATIENT_PAGE : "Patient analysis"
MAINAPP --> PIPELINE_PAGE : "System docs"
PATIENT_PAGE --> REPORT_GEN : "Generate report"
MAINAPP --> SESSION : "Store state"

' Client access
BROWSER --> STREAMLIT : "HTTP requests"
WORKSTATION --> STREAMLIT : "Secure access"
STREAMLIT --> BROWSER : "Rendered UI"

' Additional connections
CONFIG --> SUPERVISED : "Classifier config"
LOGS --> PIPELINE_PAGE : "Display metrics"

note right of MIMIC
  **MIMIC-III Database**
  - 288 patients
  - 133,157 segments
  - 8 channels (3 ECG + 5 PPG)
  - 10-second windows @ 125 Hz
end note

note right of CONTRASTIVE
  **SimCLR Contrastive Learning**
  - Batch size: 1024
  - Temperature: 0.07
  - NT-Xent loss
  - Pull positives together
  - Push negatives apart
end note

note right of XAI
  **Explainable AI Features**
  - Gradient-based saliency
  - Channel importance
  - Signal analysis (HR, HRV)
  - Abnormality detection
  - Clinical interpretation
end note

note bottom of STREAMLIT
  **Deployment**
  - http://localhost:8502
  - Real-time inference
  - PDF report generation
  - Interactive visualizations
  - Multi-page application
end note

@enduml
